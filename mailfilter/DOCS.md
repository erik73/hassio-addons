# Home Assistant Add-on: Mailfilter

Mailfilter based on Rspamd and ClamAV.

![Supports aarch64 Architecture][aarch64-shield] ![Supports amd64 Architecture][amd64-shield]
![Supports armv7 Architecture][armv7-shield]

## About

Important: This addon requires that the Mailserver add-on is installed and running!

This add-on is experimental, and provides a mailfilter for your the Mailserver add-on.
It can only filter emails for the Mailserver add-on.

## Installation

Follow these steps to get the add-on installed on your system:

Add the repository `https://github.com/erik73/hassio-addons`.
Find the "Mailfilter" add-on and click it.
Click on the "INSTALL" button.

## How to use

### Starting the add-on

After installation you are presented with a default configuration.

Adjust the add-on configuration to match your requirements.
Save the add-on configuration by clicking the "SAVE" button.
Start the add-on.

## Configuration

Example configuration:

```yaml
enable_antivirus: false
enable_dkim_signing: false
```

Please note: The antivirus option will consume lots of memory.
The absolute minimum is 4GB of RAM intsalled in the host.
Depending other add-ons that are installed 6GB might not be enough.

### Option: `enable_antivirus` (optional)

Turning this option on will enable the ClamAV virus scanner.
See above regarding the memory considerations.

### Option: `enable_gtube_tests` (optional)

Turning this option on will enable Rspamd to recognize GTUBE-like
test patterns specific to Rspamd. It is NOT recommended to turn
this on in a production environment since it might be used to
bypass the spam checks. Use it only when testing your setup!

### Option: `enable_dkim_signing` (optional)

Enables DKIM signing for outgoing emails.
At the first start with this option enabled, a DKIM key is generated.
If you turn this option off, your keys will be deleted.
New keys will be generated by enabling it once again.
The key will show in the log output. For reference, here is how the key is
generated by the add-on:
rspamadm dkim_keygen -b 2048 -s mail -k /ssl/dkim/mail.key

The selector is 'mail' and a 2048 bit rsa key is generated.
The mail.key and mail.pub files are saved in the /ssl/dkim directory in
Home Assistant. Here is a sample output in the add-on log:

```
mail._domainkey IN TXT ( "v=DKIM1; k=rsa; "
	"p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAqdBRCqYzshc4LmmkxUkCH/rcIpSe/QdNIVmBrgqZmZ5zzWQi7ShdFOH7V32/VM1VRk2pkjDV7tmfbwslsymsfxgGhVHbU0R3803uRfxAiT2mYu1hCc9351YpZF4WnrdoA3BT5juS3YUo5LsDxvZCxISnep8VqVSAZOmt8wFsZKBXiIjWuoI6XnWrzsAfoaeGaVuUZBmi4ZTg0O4yl"
	"nVlIz11McdZTRe1FlONOzO7ZkQFb7O6ogFepWLsM9tYJ38TFPteqyO3XBjxHzp1AT0UvsPcauDoeHUXgqbxU7udG1t05f6ab5h/Kih+jisgHHF4ZFK3qRtawhWlA9DtS35DlwIDAQAB"
) ;
```

If you are running your own Bind DNS server you just need to copy and paste the
record directly into your domain zone file.
If you are using a DNS web interface, you need to create a new TXT record with
mail.\_domainkey as a name while for the value/content you will need to remove the
quotes and concatenate all three lines together.
In our case the value/content of the TXT record should look like this:

```
v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAqdBRCqYzshc4LmmkxUkCH/rcIpSe/QdNIVmBrgqZmZ5zzWQi7ShdFOH7V32/VM1VRk2pkjDV7tmfbwslsymsfxgGhVHbU0R3803uRfxAiT2mYu1hCc9351YpZF4WnrdoA3BT5juS3YUo5LsDxvZCxISnep8VqVSAZOmt8wFsZKBXiIjWuoI6XnWrzsAfoaeGaVuUZBmi4ZTg0O4ylnVlIz11McdZTRe1FlONOzO7ZkQFb7O6ogFepWLsM9tYJ38TFPteqyO3XBjxHzp1AT0UvsPcauDoeHUXgqbxU7udG1t05f6ab5h/Kih+jisgHHF4ZFK3qRtawhWlA9DtS35DlwIDAQAB
```

When the DKIM option is turned off, the key files in /ssl/dkim will be deleted.
If you enable the option again, a new key will be created.

## Support

Got questions?

You could [open an issue here][issue] GitHub.

[aarch64-shield]: https://img.shields.io/badge/aarch64-yes-green.svg
[amd64-shield]: https://img.shields.io/badge/amd64-yes-green.svg
[armv7-shield]: https://img.shields.io/badge/armv7-yes-green.svg
[i386-shield]: https://img.shields.io/badge/i386-yes-green.svg
[issue]: https://github.com/erik73/addon-mailfilter/issues
[repository]: https://github.com/erik73/hassio-addons
